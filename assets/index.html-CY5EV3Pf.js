import{_ as a,c as t,a as i,o as n}from"./app-vo1rYq2c.js";const m={};function e(p,s){return n(),t("div",null,s[0]||(s[0]=[i(`<h2 id="mavros-setpoint-raw-attitude中的thrust-的坐标系" tabindex="-1"><a class="header-anchor" href="#mavros-setpoint-raw-attitude中的thrust-的坐标系"><span>/mavros/setpoint_raw/attitude中的thrust 的坐标系</span></a></h2><p>是enu的还是body的</p><blockquote><p>结论：enu的z轴</p></blockquote><blockquote><p>mavros -&gt; mavlink -&gt; uorb -&gt;</p></blockquote><p>https://docs.ros.org/en/noetic/api/mavros_msgs/html/msg/AttitudeTarget.html</p><p>通过查看mavros源码，<code>mavros/src/plugins/setpoint_raw.cpp</code> 277 行左右的<code>attitude_cb</code>函数，可以看到没有对thrust做任何处理，直接发布了SET_ATTITUDE_TARGET (id = 82)这条消息给飞控。 对于飞控，在<code>PX4-Autopilot/src/modules/mavlink/streams/mavlink_receiver.cpp</code>中完成接收，即<code>handle_message()</code>。</p><blockquote><ol><li>mavlink消息里，SET_ATTITUDE_TARGET 中不包含 和frame_id相关的变量，因此frame_id无所谓，只是用了header里的stamp。</li><li>SET_ATTITUDE_TARGET消息中有变量名thrust_body，以及thrust。 mavors在赋值时只给了thrust，px4在处理时，让thrust_body={0,0,-thrust},在之后只使用thrust_body。</li></ol></blockquote><p>自此，就可以结束了。</p><p>在 <code>handle_message_set_attitude_target()</code>中，当飞控进入offboard模式后，发送uorb消息(vehicle_attitude_setpoint)到 mc_att_control_main.cpp，thrust_body 没有做处理，接着uorb(vehicle_rates_setpoint) 给到下一环。</p><p><code>/PX4-Autopilot/src/modules/mc_rate_control/MulticopterRateControl.cpp</code> thrust_body不做处理。</p><blockquote><p>ratecontrol 的输出可以来自于 手动 ， 姿态环 ， SET_ATTITUDE_TARGET中的rate。有个问题姿态环的指令mavlink的指令 应该不能同时生效从 mask中可以猜到。</p></blockquote><div class="language-c++ line-numbers-mode" data-ext="c++" data-title="c++"><button class="copy" title="复制代码" data-copied="已复制"></button><pre class="shiki shiki-themes vitesse-light vitesse-dark vp-code"><code><span class="line"><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">uint8 type_mask  </span></span>
<span class="line"><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">uint8 IGNORE_ROLL_RATE </span><span style="--shiki-light:#999999;--shiki-dark:#666666;">=</span><span style="--shiki-light:#2F798A;--shiki-dark:#4C9A91;"> 1</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;"> # </span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;">body_rate</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">.</span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;">x</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">  </span></span>
<span class="line"><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">uint8 IGNORE_PITCH_RATE </span><span style="--shiki-light:#999999;--shiki-dark:#666666;">=</span><span style="--shiki-light:#2F798A;--shiki-dark:#4C9A91;"> 2</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;"> # </span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;">body_rate</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">.</span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;">y</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">  </span></span>
<span class="line"><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">uint8 IGNORE_YAW_RATE </span><span style="--shiki-light:#999999;--shiki-dark:#666666;">=</span><span style="--shiki-light:#2F798A;--shiki-dark:#4C9A91;"> 4</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;"> # </span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;">body_rate</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">.</span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;">z</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">  </span></span>
<span class="line"><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">uint8 IGNORE_THRUST </span><span style="--shiki-light:#999999;--shiki-dark:#666666;">=</span><span style="--shiki-light:#2F798A;--shiki-dark:#4C9A91;"> 64</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">  </span></span>
<span class="line"><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">uint8 IGNORE_ATTITUDE </span><span style="--shiki-light:#999999;--shiki-dark:#666666;">=</span><span style="--shiki-light:#2F798A;--shiki-dark:#4C9A91;"> 128</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;"> # orientation field</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="总结" tabindex="-1"><a class="header-anchor" href="#总结"><span>总结</span></a></h2><ol><li><p>/mavros/setpoint_raw/attitude 中的 thrust 是指 local_enu 坐标系下的z。</p></li><li><p>姿态描述的是from <a href="https://mavlink.io/en/messages/common.html#MAV_FRAME_LOCAL_NED" target="_blank" rel="noopener noreferrer">MAV_FRAME_LOCAL_NED</a> to <a href="https://mavlink.io/en/messages/common.html#MAV_FRAME_BODY_FRD" target="_blank" rel="noopener noreferrer">MAV_FRAME_BODY_FRD</a></p></li></ol><p>aircraft 坐标系也就是body_FRD， mavros中进行的转换如下</p><p class="katex-block"><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><msubsup><mi>q</mi><mrow><mi>n</mi><mi>e</mi><mi>d</mi></mrow><mrow><mi>e</mi><mi>n</mi><mi>u</mi></mrow></msubsup><mo>∗</mo><msubsup><mi>q</mi><mrow><mi>e</mi><mi>n</mi><mi>u</mi></mrow><mrow><mi>b</mi><mi>a</mi><mi>s</mi><mi>e</mi><mi>l</mi><mi>i</mi><mi>n</mi><mi>k</mi></mrow></msubsup><mo>∗</mo><msubsup><mi>q</mi><mrow><mi>b</mi><mi>a</mi><mi>s</mi><mi>e</mi><mi>l</mi><mi>i</mi><mi>n</mi><mi>k</mi></mrow><mrow><mi>a</mi><mi>i</mi><mi>r</mi><mi>c</mi><mi>r</mi><mi>a</mi><mi>f</mi><mi>t</mi></mrow></msubsup><mo>=</mo><msubsup><mi>q</mi><mrow><mi>n</mi><mi>e</mi><mi>d</mi></mrow><mrow><mi>a</mi><mi>i</mi><mi>r</mi><mi>c</mi><mi>r</mi><mi>a</mi><mi>f</mi><mi>t</mi></mrow></msubsup></mrow><annotation encoding="application/x-tex"> q_{ned}^{enu}*q_{enu}^{baselink} * q_{baselink}^{aircraft} = q_{ned}^{aircraft} </annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.9614em;vertical-align:-0.247em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">q</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.7144em;"><span style="top:-2.453em;margin-left:-0.0359em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">n</span><span class="mord mathnormal mtight">e</span><span class="mord mathnormal mtight">d</span></span></span></span><span style="top:-3.113em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">e</span><span class="mord mathnormal mtight">n</span><span class="mord mathnormal mtight">u</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.247em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">∗</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:1.1461em;vertical-align:-0.247em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">q</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.8991em;"><span style="top:-2.453em;margin-left:-0.0359em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">e</span><span class="mord mathnormal mtight">n</span><span class="mord mathnormal mtight">u</span></span></span></span><span style="top:-3.113em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">ba</span><span class="mord mathnormal mtight">se</span><span class="mord mathnormal mtight" style="margin-right:0.01968em;">l</span><span class="mord mathnormal mtight" style="margin-right:0.03148em;">ink</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.247em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">∗</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:1.2683em;vertical-align:-0.3013em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">q</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.967em;"><span style="top:-2.3987em;margin-left:-0.0359em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">ba</span><span class="mord mathnormal mtight">se</span><span class="mord mathnormal mtight" style="margin-right:0.01968em;">l</span><span class="mord mathnormal mtight" style="margin-right:0.03148em;">ink</span></span></span></span><span style="top:-3.1809em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">ai</span><span class="mord mathnormal mtight" style="margin-right:0.02778em;">rcr</span><span class="mord mathnormal mtight">a</span><span class="mord mathnormal mtight" style="margin-right:0.10764em;">f</span><span class="mord mathnormal mtight">t</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.3013em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:1.2683em;vertical-align:-0.3013em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">q</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.967em;"><span style="top:-2.3987em;margin-left:-0.0359em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">n</span><span class="mord mathnormal mtight">e</span><span class="mord mathnormal mtight">d</span></span></span></span><span style="top:-3.1809em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">ai</span><span class="mord mathnormal mtight" style="margin-right:0.02778em;">rcr</span><span class="mord mathnormal mtight">a</span><span class="mord mathnormal mtight" style="margin-right:0.10764em;">f</span><span class="mord mathnormal mtight">t</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.3013em;"><span></span></span></span></span></span></span></span></span></span></span></p><blockquote><p>from base_link to ENU 写作 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msubsup><mi>q</mi><mrow><mi>e</mi><mi>n</mi><mi>u</mi></mrow><mrow><mi>b</mi><mi>a</mi><mi>s</mi><mi>e</mi><mi>l</mi><mi>i</mi><mi>n</mi><mi>k</mi></mrow></msubsup></mrow><annotation encoding="application/x-tex">q_{enu}^{baselink}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.0961em;vertical-align:-0.247em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">q</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.8491em;"><span style="top:-2.453em;margin-left:-0.0359em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">e</span><span class="mord mathnormal mtight">n</span><span class="mord mathnormal mtight">u</span></span></span></span><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">ba</span><span class="mord mathnormal mtight">se</span><span class="mord mathnormal mtight" style="margin-right:0.01968em;">l</span><span class="mord mathnormal mtight" style="margin-right:0.03148em;">ink</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.247em;"><span></span></span></span></span></span></span></span></span></span></p></blockquote><ol start="3"><li>姿态</li></ol>`,18)]))}const r=a(m,[["render",e],["__file","index.html.vue"]]),o=JSON.parse('{"path":"/px4code/controller/xyb3tlxm/","title":"z_axis_ctrl","lang":"zh-CN","frontmatter":{"title":"z_axis_ctrl","createTime":"2024/09/09 13:25:30","permalink":"/px4code/controller/xyb3tlxm/","description":"/mavros/setpoint_raw/attitude中的thrust 的坐标系 是enu的还是body的 结论：enu的z轴 mavros -> mavlink -> uorb -> https://docs.ros.org/en/noetic/api/mavros_msgs/html/msg/AttitudeTarget.html 通过查看ma...","head":[["meta",{"property":"og:url","content":"https://hyaline.qyswarm.top/px4code/controller/xyb3tlxm/"}],["meta",{"property":"og:site_name","content":"Reflections of Hyaline"}],["meta",{"property":"og:title","content":"z_axis_ctrl"}],["meta",{"property":"og:description","content":"/mavros/setpoint_raw/attitude中的thrust 的坐标系 是enu的还是body的 结论：enu的z轴 mavros -> mavlink -> uorb -> https://docs.ros.org/en/noetic/api/mavros_msgs/html/msg/AttitudeTarget.html 通过查看ma..."}],["meta",{"property":"og:type","content":"article"}],["meta",{"property":"og:locale","content":"zh-CN"}],["meta",{"property":"og:updated_time","content":"2024-10-20T14:14:17.000Z"}],["meta",{"property":"article:modified_time","content":"2024-10-20T14:14:17.000Z"}],["script",{"type":"application/ld+json"},"{\\"@context\\":\\"https://schema.org\\",\\"@type\\":\\"Article\\",\\"headline\\":\\"z_axis_ctrl\\",\\"image\\":[\\"\\"],\\"dateModified\\":\\"2024-10-20T14:14:17.000Z\\",\\"author\\":[]}"]]},"headers":[{"level":2,"title":"/mavros/setpoint_raw/attitude中的thrust 的坐标系","slug":"mavros-setpoint-raw-attitude中的thrust-的坐标系","link":"#mavros-setpoint-raw-attitude中的thrust-的坐标系","children":[]},{"level":2,"title":"总结","slug":"总结","link":"#总结","children":[]}],"readingTime":{"minutes":1.19,"words":357},"git":{"createdTime":1725899925000,"updatedTime":1729433657000,"contributors":[{"name":"hyaline-wang","email":"hyaline-wang","commits":1}]},"autoDesc":true,"filePathRelative":"notes/px4code/控制器/z_axis_ctrl.md"}');export{r as comp,o as data};
