import{_ as e,c as s,a,o as t}from"./app-vo1rYq2c.js";const n={};function l(p,i){return t(),s("div",null,i[0]||(i[0]=[a(`<blockquote><p>以下是一个 debug 过程</p></blockquote><ul><li>原来的控制方法不够稳定，体现在当状态不好时悬停都十分困难。</li><li>测试这个是因为ego_planner带的控制没有很好的跟踪轨迹，有时候期望和目标位置能差20cm,躲障碍时问题就很大，就想试试直接发p a v 给px4</li></ul><h2 id="现象-vio-接入-vision-pose-就崩掉" tabindex="-1"><a class="header-anchor" href="#现象-vio-接入-vision-pose-就崩掉"><span><strong>现象</strong>: VIO 接入 vision_pose 就崩掉</span></a></h2><p>阅读了源码，发现:</p><ul><li>早先的测试中，6c 跑vins几乎没有正常过，莫名其妙的飘，原因基本可以确定是地磁的原因，vins拿到的imu数据被px4中的EKF做了处理(EKF对传感器数据修正)，因此磁场差的时候vins就会崩掉，把罗盘关掉直接就好了。</li><li>这种机制造成了一个问题，如果把vins的数据作为vision_pose 发给px4 ,让px4做EKF，会崩掉，我在固件中将对EKF对imU数据修正的处理去掉后，就不再崩了。</li></ul><h2 id="消除bias" tabindex="-1"><a class="header-anchor" href="#消除bias"><span>消除bias</span></a></h2><p>修改固件后VINS精度变差的原因排查，猜测原因如下</p><ul><li>传感器校准</li><li>外参z轴没有标定好 (猜测是主要原因)</li><li>原来的EKF对Z轴的精度提升有影响，也许融合了气压计的值</li></ul><p>始终没有将VINS标定到一个非常合适的值</p><h2 id="去掉-offset-估计" tabindex="-1"><a class="header-anchor" href="#去掉-offset-估计"><span>去掉 offset 估计</span></a></h2><h3 id="飞行状态变差" tabindex="-1"><a class="header-anchor" href="#飞行状态变差"><span>飞行状态变差</span></a></h3><p>尝试了控制定点非常稳定，但是发现画不了圆(掉高，完全称不上是圆)。</p><p><a href="https://docs.px4.io/main/en/ros/mavros_offboard_cpp.html" target="_blank" rel="noopener noreferrer">MAVROS Offboard control example (C++) | PX4 User Guide</a></p><h3 id="结论" tabindex="-1"><a class="header-anchor" href="#结论"><span>结论</span></a></h3><ol><li><p>由于VIO的 数据来源data_raw 的数据被 EKF处理过，所以不能将VIO计算出的位姿信息反给飞控做EKF。</p></li><li><p>可以修改固件使得data_raw 不被EKF处理，但是这样会出现两个隐患</p><ol><li>很难标定到一个非常好的外参，感觉每次都会有一些变化(直观感受)</li><li>手举着飞机时感觉一切正常，但是飞起来后效果就差很多了，除了悬停很稳外，剩下的几乎不可用。</li></ol></li><li><p>可以只用双目来解决 2.b出现的问题，但是飘的太快了，特别是高度（一个来回飘1m）。</p></li><li><p>由1,2,3 可推测</p><ol><li>data_raw 不是真正的raw，校正的意义是比较大的。</li><li>真正的raw效果并不好 如果实在想实现，可能必须要移植滤波算法了。</li></ol></li><li><p>可以使用一个临时的解决方法，两个飞控，一个专门用来飞行，一个专门作为VIO的数据源，看起来非常的笨，但是实测效果很不错，完全可用。</p></li><li><p>因此先用 5.的方法实现多机，写一些脚本使得使用简单一些，同时购买挑选合适的IMU，有机会也真正测一下D435i上的IMU吧。</p></li></ol><h1 id="pva-参数调试" tabindex="-1"><a class="header-anchor" href="#pva-参数调试"><span>PVA 参数调试</span></a></h1><h2 id="practise" tabindex="-1"><a class="header-anchor" href="#practise"><span>Practise</span></a></h2><div class="language-cpp line-numbers-mode" data-ext="cpp" data-title="cpp"><button class="copy" title="复制代码" data-copied="已复制"></button><pre class="shiki shiki-themes vitesse-light vitesse-dark vp-code"><code><span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">//不能这样写，注意坐标系</span></span>
<span class="line"><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;">mpCtrl</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">.</span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;">type_mask</span><span style="--shiki-light:#999999;--shiki-dark:#666666;"> =</span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;"> mpCtrl</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">.</span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;">IGNORE_YAW_RATE</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">|</span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;">mpCtrl</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">.</span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;">IGNORE_AFY</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">|</span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;">mpCtrl</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">.</span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;">IGNORE_VY</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">;</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div></div></div><p><a href="http://docs.ros.org/en/api/mavros_msgs/html/msg/PositionTarget.html" target="_blank" rel="noopener noreferrer">mavros_msgs/PositionTarget Documentation</a></p><p>MPC_XY_P 0.95→1.2</p><p>MPC_XY_VEL_P_ACC 1.8→1.2</p><p>修改 MPC_JERK_AUTO -&gt; default 4 -&gt;15</p><h2 id="参考源码与文档" tabindex="-1"><a class="header-anchor" href="#参考源码与文档"><span>参考源码与文档</span></a></h2><p>对比了源码与文档，有了新的发现</p><p>[[px4 - Multicopter Position Control 细究]]</p><h2 id="vio-输出作为-vision-pose" tabindex="-1"><a class="header-anchor" href="#vio-输出作为-vision-pose"><span>VIO 输出作为 vision_pose</span></a></h2><p>这两天有一些其他的进展，之前vins飘的原因应该算完全找到了，vins拿到的imu数据被px4中的EKF做了处理(EKF对传感器数据修正)，因此磁场差的时候vins就会崩掉，把罗盘关掉直接就好了。 这种机制造成了一个问题，如果把vins的数据作为vision_pose 发给px4 ,让px4做EKF，会崩掉，我在固件中将对EKF对imU数据修正的处理去掉后，就不再崩了。（研究这个是因为ego_planner带的控制没有很好的跟踪轨迹，有时候期望和目标位置能差20cm,躲障碍时问题就很大，就想试试直接发p a v 给px4，然后发现了这个问题） 但是 这样的VINS效果并不好，特别是飞机飞起来的时候。</p>`,27)]))}const r=e(n,[["render",l],["__file","index.html.vue"]]),h=JSON.parse('{"path":"/sizznice/","title":"vision_pose","lang":"zh-CN","frontmatter":{"title":"vision_pose","createTime":"2024/10/20 12:56:50","permalink":"/sizznice/","description":"以下是一个 debug 过程 原来的控制方法不够稳定，体现在当状态不好时悬停都十分困难。 测试这个是因为ego_planner带的控制没有很好的跟踪轨迹，有时候期望和目标位置能差20cm,躲障碍时问题就很大，就想试试直接发p a v 给px4 现象: VIO 接入 vision_pose 就崩掉 阅读了源码，发现: 早先的测试中，6c 跑vins几乎没...","head":[["meta",{"property":"og:url","content":"https://hyaline.qyswarm.top/sizznice/"}],["meta",{"property":"og:site_name","content":"Reflections of Hyaline"}],["meta",{"property":"og:title","content":"vision_pose"}],["meta",{"property":"og:description","content":"以下是一个 debug 过程 原来的控制方法不够稳定，体现在当状态不好时悬停都十分困难。 测试这个是因为ego_planner带的控制没有很好的跟踪轨迹，有时候期望和目标位置能差20cm,躲障碍时问题就很大，就想试试直接发p a v 给px4 现象: VIO 接入 vision_pose 就崩掉 阅读了源码，发现: 早先的测试中，6c 跑vins几乎没..."}],["meta",{"property":"og:type","content":"article"}],["meta",{"property":"og:locale","content":"zh-CN"}],["meta",{"property":"og:updated_time","content":"2024-10-20T14:14:17.000Z"}],["meta",{"property":"article:modified_time","content":"2024-10-20T14:14:17.000Z"}],["script",{"type":"application/ld+json"},"{\\"@context\\":\\"https://schema.org\\",\\"@type\\":\\"Article\\",\\"headline\\":\\"vision_pose\\",\\"image\\":[\\"\\"],\\"dateModified\\":\\"2024-10-20T14:14:17.000Z\\",\\"author\\":[]}"]]},"headers":[{"level":2,"title":"现象: VIO 接入 vision_pose 就崩掉","slug":"现象-vio-接入-vision-pose-就崩掉","link":"#现象-vio-接入-vision-pose-就崩掉","children":[]},{"level":2,"title":"消除bias","slug":"消除bias","link":"#消除bias","children":[]},{"level":2,"title":"去掉 offset 估计","slug":"去掉-offset-估计","link":"#去掉-offset-估计","children":[{"level":3,"title":"飞行状态变差","slug":"飞行状态变差","link":"#飞行状态变差","children":[]},{"level":3,"title":"结论","slug":"结论","link":"#结论","children":[]}]},{"level":2,"title":"Practise","slug":"practise","link":"#practise","children":[]},{"level":2,"title":"参考源码与文档","slug":"参考源码与文档","link":"#参考源码与文档","children":[]},{"level":2,"title":"VIO 输出作为 vision_pose","slug":"vio-输出作为-vision-pose","link":"#vio-输出作为-vision-pose","children":[]}],"readingTime":{"minutes":3.38,"words":1013},"git":{"createdTime":1729433657000,"updatedTime":1729433657000,"contributors":[{"name":"hyaline-wang","email":"hyaline-wang","commits":1}]},"autoDesc":true,"filePathRelative":"notes/px4code/通讯SDK/vision_pose.md","categoryList":[{"id":"4358b5","sort":10006,"name":"notes"},{"id":"928c20","sort":10009,"name":"px4code"},{"id":"2d86d5","sort":10016,"name":"通讯SDK"}]}');export{r as comp,h as data};
